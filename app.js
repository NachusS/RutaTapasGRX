/* RutaTapasGRX - app.js (multi-ruta + loader robusto + ruta discontinua WALKING con chunking + progreso por ruta) */
(()=>{const L={theme:"tapas_theme",metrics:"tapas_metrics",route:"tapas_route_path"};async function a(t){const e=await fetch(t,{cache:"no-cache"});if(!e.ok)throw new Error(`HTTP ${e.status} al cargar ${t}`);const r=await e.text();try{return JSON.parse(r)}catch{return JSON.parse(r.replace(/^\uFEFF/,"").replace(/\bNaN\b/gi,"null").replace(/\bInfinity\b/gi,"null").replace(/\b-?Inf\b/gi,"null"))}}const o=t=>typeof t=="number"?t:Number(t),p=t=>({...t,id:String(t.id||"").trim(),name:String(t.name||"").trim(),address:typeof t.address=="string"?t.address:"",tapa:String(t.tapa||"").trim(),photo:String(t.photo||"").trim(),notes:typeof t.notes=="string"?t.notes:"",lat:o(t.lat),lng:o(t.lng),order:Number(t.order||0)});const s={map:null,directionsService:null,directionsRenderer:null,overviewPolyline:null,userMarker:null,userAccuracyCircle:null,watchId:null,data:null,markers:new Map,polyline:null,currentDestinationId:null,metrics:{opens:0,clicksNext:0,geoErrors:0},routeList:[],currentRoutePath:"data/stops.json",get LS(){const t=this.currentRoutePath;return{progress:`tapas_progress::${t}`,nextStop:`tapas_nextStopId::${t}`}},async init(){location.protocol==="file:"&&alert("Para que funcione fetch/geolocalizaciÃ³n usa HTTPS (GitHub Pages) o un servidor local."),this.restoreTheme(),this.restoreMetrics(),await this.loadRoutesList(),await this.loadStops(this.currentRoutePath),this.buildUI(),this.updateProgressUI(),window.App=this},async loadRoutesList(){try{const t=await a("data/routes.json");this.routeList=t.routes||[]}catch{this.routeList=[{id:"ruta_grx_v1",title:"RutaTapasGRX (por defecto)",file:"data/stops.json"}]}const e=localStorage.getItem(L.route),r=this.routeList.find(n=>n.file===e);this.currentRoutePath=r?r.file:(this.routeList[0]?.file||"data/stops.json");const i=document.getElementById("routeSelect");i&&(i.innerHTML=this.routeList.map(n=>`<option value="${n.file}">${n.title}</option>`).join(""),i.value=this.currentRoutePath,i.addEventListener("change",async n=>{const d=n.target.value;localStorage.setItem(L.route,d),await this.switchRoute(d)}))},async switchRoute(t){this.currentDestinationId=null,this.clearMapArtifacts(),await this.loadStops(t),this.buildUI(),this.updateProgressUI(),this.map?(this.drawMarkers(),this.drawPolylineFallback(),this.drawOverviewRoute()):this.initMap()},clearMapArtifacts(){this.directionsRenderer&&(()=>{try{this.directionsRenderer.set("directions",null)}catch{}})(),this.overviewPolyline&&(()=>{try{this.overviewPolyline.setMap(null)}catch{}this.overviewPolyline=null})(),this.polyline&&(()=>{try{this.polyline.setMap(null)}catch{}this.polyline=null})(),this.markers&&this.markers.size&&(this.markers.forEach(t=>{try{t.setMap(null)}catch{}}),this.markers=new Map);const t=document.getElementById("stopsList");t&&(t.innerHTML="")},async loadStops(t="data/stops.json"){try{const e=await a(t);e.stops=(e.stops||[]).map(p).sort((r,i)=>(r.order||0)-(i.order||0)),this.data=e,document.title=e.meta?.title||document.title;const r=document.getElementById("appTitle");r&&(r.textContent=e.meta?.title||"RutaTapasGRX"),this.currentRoutePath=t}catch(e){console.error("No se pudieron cargar las paradas:",e),alert("No se pudieron cargar las paradas. Revisa JSON y usa HTTPS."),this.data={meta:{},stops:[]}}},initMap(){if(!this.data)return;const t={lat:this.data.meta?.start?.lat||37.176,lng:this.data.meta?.start?.lng||-3.598};this.map=new google.maps.Map(document.getElementById("map"),{center:t,zoom:15,mapTypeControl:!1,fullscreenControl:!0,streetViewControl:!1}),this.directionsService=new google.maps.DirectionsService,this.directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:!0,polylineOptions:{strokeWeight:5,strokeColor:"#2563eb"}}),this.directionsRenderer.setMap(this.map),this.drawMarkers(),this.drawPolylineFallback(),this.drawOverviewRoute(),this.setupGeolocation(),this.restoreNextStop()},drawMarkers(){const t=this.data.meta?.start,e=this.data.meta?.end,r=this.data.stops,i=new google.maps.InfoWindow;t&&Number.isFinite(t.lat)&&Number.isFinite(t.lng)&&this.markers.set("START",new google.maps.Marker({position:{lat:t.lat,lng:t.lng},map:this.map,title:`Inicio: ${t.name||"Inicio"}`,icon:this.flagIcon("#10b981")})),e&&Number.isFinite(e.lat)&&Number.isFinite(e.lng)&&this.markers.set("END",new google.maps.Marker({position:{lat:e.lat,lng:e.lng},map:this.map,title:`Fin: ${e.name||"Fin"}`,icon:this.flagIcon("#f59e0b")})),(r||[]).forEach(n=>{if(!Number.isFinite(n.lat)||!Number.isFinite(n.lng))return;const d=new google.maps.Marker({position:{lat:n.lat,lng:n.lng},map:this.map,title:`${n.order}. ${n.name}`,label:{text:String(n.order),fontSize:"12px",fontWeight:"700"}});d.addListener("click",()=>{i.setContent(this.stopInfoHTML(n)),i.open(this.map,d),this.focusCard(n.id)}),this.markers.set(n.id,d)})},buildCoordList(){const t=(this.data?.stops||[]).filter(e=>Number.isFinite(e.lat)&&Number.isFinite(e.lng)).map(e=>({lat:e.lat,lng:e.lng})),e=this.data?.meta?.start,r=this.data?.meta?.end,i=e&&Number.isFinite(e.lat)&&Number.isFinite(e.lng),n=r&&Number.isFinite(r.lat)&&Number.isFinite(r.lng),d=[];return i&&d.push({lat:e.lat,lng:e.lng}),d.push(...t),n&&d.push({lat:r.lat,lng:r.lng}),!d.length&&t.length&&d.push(...t),d},chunkRoutePoints(t,e=25){const r=[];if(!t||t.length<2)return r;let i=0;for(;i<t.length-1;){const n=t.length-i,d=Math.min(e,n);let u=t.slice(i,i+d);u.length===1&&i+1<t.length&&(u=[t[i],t[i+1]]);const c=u[0],l=u[u.length-1],g=u.slice(1,-1).map(h=>({location:h,stopover:!0}));r.push({origin:c,destination:l,waypoints:g}),i+=u.length-1}return r},async fetchChunkPath({ origin:t, destination:e, waypoints:r }){const i={origin:t,destination:e,waypoints:r,optimizeWaypoints:!1,travelMode:google.maps.TravelMode.WALKING},n=await this.directionsService.route(i),d=n.routes?.[0];if(!d)return[];const u=d.overview_path||[];return u.map(c=>({lat:c.lat(),lng:c.lng()}))},async drawOverviewRoute(){this.overviewPolyline&&(()=>{try{this.overviewPolyline.setMap(null)}catch{}this.overviewPolyline=null})();const t=this.buildCoordList();if(t.length<2)return;const e=this.chunkRoutePoints(t,25),r={path:"M 0,-1 0,1",strokeOpacity:1,scale:3,strokeColor:"#111827"};try{const i=[];for(const n of e){const d=await this.fetchChunkPath(n);if(d.length)if(i.length){const u=i[i.length-1],c=d[0],l=u.lat===c.lat&&u.lng===c.lng;i.push(...(l?d.slice(1):d))}else i.push(...d)}i.length>=2?this.overviewPolyline=new google.maps.Polyline({path:i,strokeOpacity:0,icons:[{icon:r,offset:"0",repeat:"12px"}],map:this.map}):this.drawPolylineFallback()}catch(i){console.warn("Overview (chunked) fallo; usando fallback simple",i),this.drawPolylineFallback()}},flagIcon(t){const e=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='none' stroke='${t}' stroke-width='2'><path d='M4 2v20'/><path fill='${t}' d='M4 3h11l-2 3 2 3H4z'/></svg>`);return{url:`data:image/svg+xml;charset=UTF-8,${e}`,scaledSize:new google.maps.Size(28,28),anchor:new google.maps.Point(6,26)}},stopInfoHTML(t){const e=t.address?`<div class="meta">${t.address}</div>`:"",r=t.photo?t.photo:"assets/cover.jpg",i=this.isDone(t.id);return`<div class="infobox"><div style="display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:start">
        <img src="${r}" alt="Foto de ${this.escape(t.name)}" width="110" height="80" style="border-radius:8px;object-fit:cover" />
        <div><strong>${t.order}. ${this.escape(t.name)}</strong>${e}<div class="meta">Tapa: ${this.escape(t.tapa||"â€”")}</div>
          <div class="actions" style="margin-top:6px"><button class="btn ${i?"":"primary"}" data-action="toggle" data-id="${t.id}">${i?"Desmarcar":"Marcar como hecha"}</button>
          <button class="btn" data-action="goto" data-id="${t.id}">Ir a esta parada</button></div></div></div></div>`},drawPolylineFallback(){const t=(this.data.stops||[]).filter(e=>Number.isFinite(e.lat)&&Number.isFinite(e.lng)).map(e=>({lat:e.lat,lng:e.lng}));this.polyline&&this.polyline.setMap(null),t.length&&(this.polyline=new google.maps.Polyline({path:t,geodesic:!0,strokeColor:"#2563eb",strokeOpacity:.25,strokeWeight:4}),this.polyline.setMap(this.map))},async routeTo(t){const e=(this.data.stops||[]).find(r=>r.id===t)||null;if(!e)return;this.currentDestinationId=t,localStorage.setItem(this.LS.nextStop,t);let r=null;if(this.userMarker&&(r=this.userMarker.getPosition()),!r){const i=(this.data.stops||[]).findIndex(n=>n.id===t);r=i>0?{lat:this.data.stops[i-1].lat,lng:this.data.stops[i-1].lng}:{lat:this.data.meta?.start?.lat||e.lat,lng:this.data.meta?.start?.lng||e.lng}}try{const i=await this.directionsService.route({origin:r,destination:{lat:e.lat,lng:e.lng},travelMode:google.maps.TravelMode.WALKING});this.directionsRenderer.setDirections(i);const n=i.routes[0].legs[0];this.map.fitBounds(i.routes[0].bounds),this.announce(`Direcciones hacia ${e.name}. Distancia ${n.distance?.text||"â€”"}, tiempo estimado ${n.duration?.text||"â€”"}.`)}catch(i){console.warn("Directions fallo",i),this.map.panTo({lat:e.lat,lng:e.lng}),this.map.setZoom(16),this.announce("No se pudo calcular la ruta con Directions.")}},buildUI(){const t=document.getElementById("stopsList");if(!t)return;t.innerHTML="";const e=this.data.stops||[];e.forEach(r=>{const i=document.createElement("li");i.className="card",i.id=`card-${r.id}`,i.innerHTML=`<img src="${r.photo||"assets/cover.jpg"}" alt="Foto de ${this.escape(r.name)}"><div>
          <h3>${r.order}. ${this.escape(r.name)}</h3>
          <div class="meta">${r.address?this.escape(r.address):""}</div>
          <div class="meta">Tapa: ${this.escape(r.tapa||"â€”")}</div>
          <div class="actions">
            <button class="btn ${this.isDone(r.id)?"":"primary"}" data-action="toggle" data-id="${r.id}" aria-pressed="${this.isDone(r.id)}">${this.isDone(r.id)?"Desmarcar":"Marcar como hecha"}</button>
            <button class="btn" data-action="goto" data-id="${r.id}">Ir a esta parada</button>
          </div>
        </div>`,t.appendChild(i)}),document.body.addEventListener("click",r=>{const i=r.target.closest('button[data-action]');if(!i)return;const n=i.getAttribute("data-id"),d=i.getAttribute("data-action");d==="toggle"&&this.toggleDone(n),d==="goto"&&this.routeTo(n)});const r=document.getElementById("startBtn");r&&r.addEventListener("click",()=>{const i=this.firstPending()||(this.data.stops?.[0]?.id);i&&this.routeTo(i)});const i=document.getElementById("nextBtn");i&&i.addEventListener("click",()=>{this.metrics.clicksNext++,this.persistMetrics();const n=this.nextStop();n&&this.routeTo(n.id)});const n=document.getElementById("resetBtn");n&&n.addEventListener("click",()=>{confirm("Â¿Seguro que quieres reiniciar el checklist?")&&(localStorage.removeItem(this.LS.progress),localStorage.removeItem(this.LS.nextStop),this.refreshCards(),this.updateProgressUI(),this.announce("Checklist reiniciado."))});const d=document.getElementById("themeBtn");d&&d.addEventListener("click",()=>{const u=document.documentElement,c=u.getAttribute("data-theme")==="dark"?"light":"dark";u.setAttribute("data-theme",c),localStorage.setItem(L.theme,c),d.setAttribute("aria-pressed",String(c==="dark"))})},escape(t){return String(t||"").replace(/[&<>\"']/g,t=>({"&":"&amp;","<":"&lt;"," >":"&gt;",'"':"&quot;","'":"&#39;"}[t]))},toggleDone(t){const e=this.readProgress();e[t]=!e[t],localStorage.setItem(this.LS.progress,JSON.stringify(e)),this.refreshCards(),this.updateProgressUI();if(e[t]&&this.currentDestinationId===t){const r=this.nextStop();r&&this.announce(`Â¡Bien! Avanza a ${r.name}.`) }},refreshCards(){(this.data.stops||[]).forEach(t=>{const e=document.getElementById(`card-${t.id}`);if(!e)return;const r=e.querySelector('button[data-action="toggle"]'),i=this.isDone(t.id);r.textContent=i?"Desmarcar":"Marcar como hecha",r.classList.toggle("primary",!i),r.setAttribute("aria-pressed",String(i)),e.style.opacity=i?.65:1})},isDone(t){const e=this.readProgress();return!!e[t]},readProgress(){try{return JSON.parse(localStorage.getItem(this.LS.progress)||"{}")}catch{return{}}},firstPending(){return(this.data.stops||[]).find(t=>!this.isDone(t.id))?.id||null},nextStop(){const t=this.data.stops||[],e=this.currentDestinationId?t.findIndex(r=>r.id===this.currentDestinationId):-1,r=e>=0?t.slice(e+1).concat(t.slice(0,e+1)):t,i=r.find(n=>!this.isDone(n.id));return i||t[t.length-1]||null},updateProgressUI(){const t=this.data?.stops?.length||0,e=(this.data.stops||[]).filter(r=>this.isDone(r.id)).length,r=t?Math.round(e/t*100):0,i=document.getElementById("progressText");i&&(i.textContent=`Completadas ${e} / ${t}`);const n=document.getElementById("progressBarFill");n&&(n.style.width=`${r}%`)},focusCard(t){const e=document.getElementById(`card-${t}`);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("focus-pulse"),setTimeout(()=>e.classList.remove("focus-pulse"),700))},setupGeolocation(){if(!("geolocation"in navigator)){alert("GeolocalizaciÃ³n no disponible.");return}this.watchId=navigator.geolocation.watchPosition(t=>{const{latitude:e,longitude:r,accuracy:i}=t.coords,n={lat:e,lng:r};this.userMarker?this.userMarker.setPosition(n):(this.userMarker=new google.maps.Marker({position:n,map:this.map,title:"Tu posiciÃ³n",icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,fillColor:"#ef4444",fillOpacity:1,strokeWeight:2}}),this.userAccuracyCircle=new google.maps.Circle({strokeColor:"#ef4444",strokeOpacity:.3,strokeWeight:1,fillColor:"#ef4444",fillOpacity:.08,map:this.map,center:n,radius:i})),this.userAccuracyCircle&&(this.userAccuracyCircle.setCenter(n),this.userAccuracyCircle.setRadius(i))},t=>{this.metrics.geoErrors++,this.persistMetrics(),console.warn("Geo error",t),this.announce("GeolocalizaciÃ³n no disponible o permiso denegado.")},{enableHighAccuracy:!0,maximumAge:1e4,timeout:2e4})},restoreTheme(){const t=localStorage.getItem(L.theme),e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,r=t||(e?"dark":"light");document.documentElement.setAttribute("data-theme",r);const i=document.getElementById("themeBtn");i&&i.setAttribute("aria-pressed",String(r==="dark"))},restoreNextStop(){const t=localStorage.getItem(this.LS.nextStop);t&&(this.currentDestinationId=t)},announce(t){const e=document.querySelector(".progress-wrap");if(!e)return;const r=document.createElement("div");r.className="sr-only",r.textContent=t,e.appendChild(r),setTimeout(()=>r.remove(),1200)},persistMetrics(){localStorage.setItem(L.metrics,JSON.stringify(this.metrics))},restoreMetrics(){try{const t=JSON.parse(localStorage.getItem(L.metrics)||"{}");this.metrics={opens:(t.opens||0)+1,clicksNext:t.clicksNext||0,geoErrors:t.geoErrors||0},this.persistMetrics()}catch{this.metrics={opens:1,clicksNext:0,geoErrors:0},this.persistMetrics()}};s.init(),window.App=s})();
